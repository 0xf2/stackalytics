#!/bin/bash

if [[ -z $STACKALYTICS_HOME ]]; then
echo "Variable STACKALYTICS_HOME must be specified"
exit
fi

echo "Analytics home is $STACKALYTICS_HOME"

DASHBOARD_CONF='$STACKALYTICS_HOME/conf/dashboard.conf'

TOP_DIR=$(cd $(dirname "$0") && pwd)

DB_FILE=`mktemp -u --tmpdir=$STACKALYTICS_HOME/data stackalytics-XXXXXXXXXXXX.sqlite`
TEMP_CONF=`mktemp -u`

cd $TOP_DIR/../scripts/
./pull-repos.sh

cd $TOP_DIR/../
./bin/stackalytics --config-file $STACKALYTICS_HOME/conf/analytics.conf --db-database $DB_FILE --verbose

DATE=`date -u +'%d-%b-%y %H:%M %Z'`

echo DATABASE = \'$DB_FILE\' >> $TEMP_CONF
echo LAST_UPDATE = \'$DATE\' >> $TEMP_CONF

#rm $DASHBOARD_CONF
#mv $TEMP_CONF $DASHBOARD_CONF

echo "Data is refreshed, please restart service"
