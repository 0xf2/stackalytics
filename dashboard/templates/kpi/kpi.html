{% extends "kpi/base_kpi.html" %}

{% block title %}
    Group KPI
{% endblock %}

{% block scripts %}
    <script type="text/javascript">

        function goal_position_in_top_loader(id, url, target_id, target_value) {
            $.ajax({
                url: make_uri(url),
                dataType: "jsonp",
                success: function (data) {
                    data = data["stats"];
                    var position = -1;

                    for (var i = 0; i < data.length; i++) {
                        if (data[i].id == target_id) {
                            position = data[i].index;
                            break;
                        }
                    }
                    var isOk = false;
                    var message = "";
                    if (position >= 0) {
                        if (position <= target_value) {
                            isOk = true;
                            message = "Target position is " + target_value;
                        } else {
                            message = "Position " + position + " is worse than target position " + target_value;
                        }
                    } else {
                        message = "Target " + target_id + " is not found";
                    }

                    $("#position_target_marker_" + id).addClass(isOk? "kpi_good": "kpi_bad").text(position);
                    $("#position_target_note_" + id).show().text(message);
                }
            });
        }

    </script>
{% endblock %}

{% macro goal_position_in_top(record_filter, item_type, item_id, target_position, title) -%}

    {% set id = title.replace(' ', '_') %}
    {% set uri = '/api/1.0/stats/' + item_type %}

    <script type="application/javascript">
        $(document).ready(function () {
            goal_position_in_top_loader("{{ id }}", "{{ record_filter|make_url(uri)|safe }}", "{{ item_id }}", "{{ target_position }}");
        });
    </script>

    <div id="position_target" class="kpi_block">
        <div id="position_target_marker_{{ id }}" class="kpi_marker"></div>
        <div class="kpi_title_block">
            <div class="kpi_title">{{ title }}</div>
            <div class="kpi_note" id="position_target_note_{{ id }}"></div>
        </div>
    </div>

{%- endmacro %}

{% block content %}
    <h1>Metrics</h1>

    {{ goal_position_in_top({'release': 'icehouse', 'project_type': 'openstack', 'metric': 'commits'}, 'companies', 'Mirantis', 5, 'Position by commits') }}
    {{ goal_position_in_top({'release': 'icehouse', 'project_type': 'openstack', 'metric': 'marks'}, 'engineers', 'boris-42', 5, 'Position by reviews') }}
    {{ goal_position_in_top({'release': 'icehouse', 'project_type': 'openstack', 'metric': 'marks', 'module': 'glance', 'filter': 'non-core'},
                            'engineers', 'boris-42', 3, 'Top-3 in non-core top reviewers') }}

{% endblock %}
